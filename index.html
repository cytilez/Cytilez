<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Kael BnB Manager ‚Äî Full UI</title>
<style>
   :root{
    --bg:#0f1116; --panel:#171a22; --panel2:#1d2330; --ink:#e9eef7; --muted:#9aa6b2; --accent:#66b3ff; --ok:#36d17b; --warn:#ffc857; --bad:#ff6b6b;
    --line:#0a0c11; --chip:#232b3a; --chip2:#263246;
  }
  *{box-sizing:border-box; font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
  body{margin:0;background:var(--bg);color:var(--ink);}
  header{display:flex;align-items:center;gap:12px;padding:14px 16px;background:var(--panel);position:sticky;top:0;z-index:20;border-bottom:1px solid #000}
  h1{margin:0;font-size:18px}
  nav{display:flex;gap:8px;flex-wrap:wrap}
  .tab{background:#222734;border:1px solid #000;color:var(--ink);padding:8px 10px;border-radius:8px;cursor:pointer;font-size:14px}
  .tab.active{outline:2px solid var(--accent)}
  main{display:grid;grid-template-columns:280px 1fr;gap:14px;padding:14px}
  body.sidebar-collapsed main{grid-template-columns:1fr}
  body.sidebar-collapsed aside{display:none}
  aside{background:var(--panel);border:1px solid #000;border-radius:12px;padding:12px;min-height:72vh}
  section{background:var(--panel);border:1px solid #000;border-radius:12px;padding:12px;min-height:72vh}
  .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  .col{display:flex;flex-direction:column;gap:6px}
  label{font-size:12px;color:var(--muted)}
  input,select,textarea,button{background:#212733;border:1px solid #000;color:var(--ink);padding:8px 10px;border-radius:8px;font-size:14px}
  button{cursor:pointer}
  button.primary{background:#2a3547}
  .list{display:flex;flex-direction:column;gap:8px;margin-top:8px}
  .unit{display:flex;align-items:center;gap:10px;background:#212733;border:1px solid #000;border-radius:10px;padding:10px}
  .dot{width:14px;height:14px;border-radius:50%}
  .unit .name{font-weight:600}
  .unit .actions{margin-left:auto;display:flex;gap:6px}
  .unit .actions button{padding:2px 6px;font-size:12px;line-height:1.2;background:#212733;border-color:#2a2f3d}
  .calbar{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
  .calendar{display:grid;grid-template-columns:repeat(7,1fr);gap:4px}
  .dow{font-size:12px;color:var(--muted);text-align:center;padding:4px 0}
  .cell{background:#1d2330;border:1px solid #000;min-height:80px;border-radius:8px;padding:4px;position:relative}
  .date{position:absolute;right:6px;top:4px;font-size:11px;color:var(--muted)}
  .add-mini{position:absolute;left:6px;top:4px;font-size:11px;opacity:.8;cursor:pointer}
  .pill{background:var(--chip);border:1px solid #000;border-left:6px solid var(--accent);border-radius:8px;padding:4px 6px;margin-top:18px;font-size:12px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .pill .cap{opacity:.75}
  .grid{display:grid;grid-template-columns:repeat(12,1fr);gap:8px}
  .card{background:#1a2030;border:1px solid #000;border-radius:10px;padding:10px}
  .kpi{display:flex;flex-direction:column;gap:2px}
  .kpi .v{font-size:20px;font-weight:700}
  table{width:100%;border-collapse:collapse}
  th,td{border-bottom:1px dashed #000;padding:8px;text-align:left;font-size:13px}
  th{color:var(--muted);font-weight:600}
  .right{text-align:right}
  .badge{padding:2px 6px;border-radius:6px;font-size:12px;background:var(--chip2);border:1px solid #000}
  .flex{display:flex;gap:8px;align-items:center}
  .spacer{flex:1}
  .hint{font-size:12px;color:var(--muted)}
  .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.45);z-index:50}
  .modal .sheet{width:min(900px,96vw);background:var(--panel);border:1px solid #000;border-radius:12px;padding:12px}
  .two{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .three{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px}
  .tiny{font-size:11px;color:var(--muted)}
  /* --- Mobile polish ------------------------------------------------------- */
@media (max-width: 768px){
  html,body{font-size:15px}

  header{
    gap:8px;
    padding:10px 12px;
    flex-wrap:wrap;              /* allow wrapping on small screens */
  }

  /* Make the main tabs horizontally scrollable pills */
  nav{
    order:2;                     /* push nav below the title on wrap */
    width:100%;
    overflow-x:auto;
    -webkit-overflow-scrolling:touch;
    padding-bottom:4px;
    scrollbar-width:none;
  }
  nav::-webkit-scrollbar{display:none}
  nav .tab{
    white-space:nowrap;
    padding:6px 8px;
    font-size:13px;
    border-radius:7px;
  }

  /* Action buttons on the right: allow wrap + shrink slightly */
  header > .spacer{display:none} /* remove big spacer so buttons can wrap */
  header > button,
  header label.tiny,
  #saveChangesBtn{
    padding:6px 8px;
    font-size:13px;
    white-space:nowrap;
  }

  /* Layout: collapse sidebar by default on mobile */
  main{grid-template-columns:1fr; padding:10px}
  aside{display:none}            /* hidden unless user toggles */
  body.sidebar-collapsed main{grid-template-columns:1fr} /* keep consistent */

  /* Cards, grids, calendar density */
  .calendar .cell{min-height:56px}
  .date{font-size:10px; right:6px; top:4px}
  .add-mini{font-size:10px}
  .pill{font-size:11px; margin-top:14px; border-radius:7px}

  /* Tables: make them scroll instead of overflowing */
  table{
    display:block;
    overflow-x:auto;
    -webkit-overflow-scrolling:touch;
    white-space:nowrap;
    border-spacing:0;
  }
  thead, tbody, tr{display:table; width:100%} /* keep borders looking sane on iOS */

  /* Inputs */
  input,select,textarea,button{padding:7px 9px; font-size:14px}

  /* Modals: use most of the screen & scroll inside */
  .modal .sheet{
    width:96vw;
    max-height:90vh;
    overflow:auto;
  }

  /* Section padding */
  section{padding:10px}
}

/* Tiny phones */
@media (max-width: 380px){
  h1{font-size:16px}
  nav .tab{padding:5px 7px; font-size:12px}
  header > button,#saveChangesBtn{font-size:12px; padding:6px 7px}
}

</style>
</head>
<body>
  <div id="toast" style="position:fixed;left:50%;top:16px;transform:translateX(-50%);background:#1f2734;color:#e9eef7;border:1px solid #000;border-radius:8px;padding:10px 14px;font-size:14px;display:none;z-index:1000;box-shadow:0 8px 22px rgba(0,0,0,.4)"></div>

  <header>
    <h1>üè° Kael BnB Manager <span id="modeLabel" class="tiny" style="opacity:.7"></span></h1>
    <nav>
      <button class="tab active" data-tab="master">Master Calendar</button>
      <button class="tab" data-tab="units">Units & Calendars</button>
      <button class="tab" data-tab="bookings">Bookings</button>
      <button class="tab" data-tab="earnings">Earnings</button>
      <button class="tab" data-tab="expenses">Expenses</button>
      <button class="tab" data-tab="settings">Settings</button>
      <!-- üî• Save changes button -->
      <button id="saveChangesBtn" class="primary">üíæ Save changes</button>
    </nav>
    <span class="spacer"></span>
    <button id="toggleSidebar" title="Show/Hide units">Toggle units</button>
    <button id="viewConflicts" title="View overlaps">Conflicts (<span id="confCount">0</span>)</button>
    <button id="syncAll">Sync all (Function)</button>
    <button id="exportBtn">Export JSON</button>
    <label class="tiny">Import JSON <input id="importFile" type="file" accept="application/json" style="display:none"></label>
    <button id="importBtn">Import‚Ä¶</button>
  </header>
  <main>
    <aside>
      <div class="row">
        <div class="col" style="flex:1">
          <label>New unit</label>
          <input id="unitName" placeholder="e.g., Loft A, Sea View 2BR" />
        </div>
        <div class="col" style="width:120px">
          <label>Color</label>
          <input id="unitColor" type="color" value="#66b3ff" />
        </div>
      </div>
      <div class="row" style="margin-top:8px">
        <button id="addUnit" class="primary">+ Add Unit</button>
      </div>
      <div class="list" id="unitList"></div>
    </aside>

    <section id="view"></section>
  </main>

  <!-- Booking Modal -->
  <div class="modal" id="bookingModal">
    <div class="sheet">
      <div class="row" style="justify-content:space-between;align-items:center">
        <h3 style="margin:0">Booking</h3>
        <div class="row">
          <button id="saveBooking" class="primary">Save</button>
          <button id="deleteBooking">Delete</button>
          <button id="closeBooking">Close</button>
        </div>
      </div>
      <div class="three" style="margin-top:8px">
        <div class="col"><label>Unit</label><select id="bkUnit"></select></div>
        <div class="col"><label>Guest</label><input id="bkGuest" placeholder="Guest name" /></div>
        <div class="col"><label>Status</label>
          <select id="bkStatus">
            <option value="booked" selected>Booked</option>
            <option value="blocked">Blocked</option>
            <option value="maintenance">Maintenance</option>
            <option value="hold">Hold</option>
            <option value="cancelled">Cancelled</option>
          </select>
        </div>
      </div>
      <div class="three">
        <div class="col"><label>Check-in</label><input id="bkIn" type="date"></div>
        <div class="col"><label>Check-out</label><input id="bkOut" type="date"></div>
        <div class="col"><label>Nights</label><input id="bkNights" type="number" min="1" value="1"></div>
      </div>
      <div class="three">
        <div class="col"><label>Nightly rate</label><input id="bkNightly" type="number" min="0" step="0.01" value="0"></div>
        <div class="col"><label>Cleaning fee</label><input id="bkCleaning" type="number" min="0" step="0.01" value="0"></div>
        <div class="col"><label>Other fees</label><input id="bkFees" type="number" min="0" step="0.01" value="0"></div>
      </div>
      <div class="two">
        <div class="col"><label>Source</label>
          <select id="bkSource">
            <option>Airbnb</option><option>Booking.com</option><option>Vrbo</option><option>Direct</option><option>Other</option>
            <option>Airbnb iCal</option><option>Booking.com iCal</option><option>Vrbo iCal</option><option>Other iCal</option><option>iCal file</option>
          </select>
        </div>
        <div class="col"><label>Notes</label>
          <input id="bkNotes" placeholder="Optional details‚Ä¶" />
        </div>
      </div>
      <div class="row" style="margin-top:6px">
        <div class="kpi"><span class="tiny">Estimated total</span><span class="v" id="bkTotal">‚Äî</span></div>
        <span class="spacer"></span>
        <div class="hint">Totals = nights √ó nightly + cleaning + other fees</div>
      </div>
    </div>
  </div>

  <!-- Sync Modal -->
  <div class="modal" id="syncModal">
    <div class="sheet">
      <div class="row" style="justify-content:space-between;align-items:center">
        <h3 style="margin:0">Sync sources</h3>
        <div class="row">
          <button id="syncSave" class="primary">Save</button>
          <button id="syncProxy">Import via Proxy</button>
          <button id="syncClose">Close</button>
        </div>
      </div>
      <div class="row" style="gap:10px;margin-top:8px;flex-wrap:wrap">
        <div class="col" style="flex:1;min-width:260px"><label>Airbnb iCal URL</label><input id="icalAirbnb" placeholder="[https://...ics"></div]https://...ics"></div>
        <div class="col" style="flex:1;min-width:260px"><label>Booking.com iCal URL</label><input id="icalBooking" placeholder="[https://...ics"></div]https://...ics"></div>
        <div class="col" style="flex:1;min-width:260px"><label>Vrbo iCal URL</label><input id="icalVrbo" placeholder="[https://...ics"></div]https://...ics"></div>
        <div class="col" style="flex:1;min-width:260px"><label>Other iCal URL</label><input id="icalOther" placeholder="[https://...ics"></div]https://...ics"></div>
      </div>
      <div class="row" style="margin-top:8px">
        <label class="tiny"><input id="autoSync" type="checkbox" /> Auto‚Äësync on app open</label>
        <span class="spacer"></span>
        <label class="tiny">Or upload .ics <input id="icsFile" type="file" accept=".ics,text/calendar" /></label>
      </div>
      <div class="tiny" id="funcHint"></div>
      <div class="tiny" id="lastSyncRow" style="margin-top:6px"></div>
    </div>
  </div>
<script>
(function(){
  const $ = s => document.querySelector(s);
  const $$ = s => Array.from(document.querySelectorAll(s));

  function toast(msg, ms=1800){
    const t = document.getElementById('toast'); if(!t) return;
    t.textContent = msg; t.style.display='block';
    clearTimeout(window.__toastTimer); window.__toastTimer = setTimeout(()=> t.style.display='none', ms);
  }

  // ---------- Storage ----------
  const KEY = 'kael_bnb_v1';
  const data = load();
  let dirty = false; // track unsaved local changes
  function load(){
    try{
      const raw = localStorage.getItem(KEY);
      if (!raw) return { units:[], bookings:[], expenses:[], settings:{ currency:'SEK', sidebarCollapsed:false, autoRestoreFromGit:true }, conflicts:[], meta:{updatedAt:null} };
      const obj = JSON.parse(raw);
      obj.settings = Object.assign({ currency:'SEK', sidebarCollapsed:false, autoRestoreFromGit:true }, obj.settings||{});
      obj.conflicts = obj.conflicts || [];
      obj.meta = obj.meta || {updatedAt:null};
      return obj;
    } catch(e){
      return { units:[], bookings:[], expenses:[], settings:{ currency:'SEK', sidebarCollapsed:false, autoRestoreFromGit:true }, conflicts:[], meta:{updatedAt:null} };
    }
  }
  function save(){
    data.meta = data.meta || {};
    data.meta.updatedAt = new Date().toISOString();
    localStorage.setItem(KEY, JSON.stringify(data));
    updateConflictBadge();
    dirty = true; // mark as changed locally
  }
  function markClean(){ dirty = false; }

  // ---------- Helpers ----------
  function uid(){ return 'id'+Math.random().toString(36).slice(2)+Date.now().toString(36); }
  function fmtMoney(x){ const c = data.settings.currency || 'SEK'; return new Intl.NumberFormat(undefined, {style:'currency',currency:c, maximumFractionDigits:0}).format(isFinite(x)?x:0); }
  function daysBetween(a,b){ const d1=new Date(a), d2=new Date(b); return Math.max(0, Math.round((d2-d1)/(1000*60*60*24))); }
  function monthMatrix(year, month){
    const first = new Date(year,month,1);
    const start = new Date(first); start.setDate(1 - ((first.getDay()+6)%7)); // Monday start
    const weeks=[]; for(let w=0; w<6; w++){ const row=[]; for(let d=0; d<7; d++){ const cur=new Date(start); cur.setDate(start.getDate()+w*7+d); row.push(cur); } weeks.push(row); }
    return weeks;
  }
  function toISO(d){ const dt=new Date(d); dt.setMinutes(dt.getMinutes()-dt.getTimezoneOffset()); return dt.toISOString().slice(0,10); }
  function shortDate(d){ const dt=new Date(d); return dt.toLocaleDateString(undefined,{month:'short',day:'numeric'}); }
  function unitName(id){ const u = data.units.find(x=>x.id===id); return u?u.name:'(unit)'; }
  function unitColor(id){ const u = data.units.find(x=>x.id===id); return u?u.color:'#66b3ff'; }
  const getUnitDefaultRate = (id)=>{ const u = data.units.find(x=>x.id===id); return u && isFinite(u.nightlyDefault) ? Number(u.nightlyDefault) : 0; };

  // Overlap / Duplicate helpers
  const rangesOverlap = (aStart,aEnd,bStart,bEnd)=> (aStart<bEnd)&&(bStart<aEnd);
  function findOverlaps(unitId, checkIn, checkOut, excludeId=null){
    return data.bookings.filter(b =>
      b.unitId===unitId &&
      b.status!=='cancelled' && b.status!=='maintenance' && b.status!=='blocked' &&
      (!excludeId || b.id!==excludeId) &&
      rangesOverlap(checkIn, checkOut, b.checkIn, b.checkOut)
    );
  }
  function findDupBooking({unitId, checkIn, checkOut, guest, importUid}){
    return data.bookings.find(b =>
      b.unitId===unitId && (
        (importUid && b.importUid && b.importUid===importUid) ||
        (b.checkIn===checkIn && b.checkOut===checkOut && (b.guest||'')===(guest||''))
      )
    );
  }
  function logConflict(newBooking, existingList, reason='overlap'){
    data.conflicts.push({
      id: uid(), unitId: newBooking.unitId, newId: newBooking.id,
      existingIds: existingList.map(x=>x.id), reason, createdAt: new Date().toISOString()
    });
    save();
  }
  function updateConflictBadge(){ const n=(data.conflicts||[]).length; const el=$('#confCount'); if(el) el.textContent=n; }

  // ---------- Proxy detection ----------
  async function checkProxy() {
    try { const r = await fetch('/.netlify/functions/fetch-ical?ping=1',{cache:'no-store'}); return r.ok; } catch(e){ return false; }
  }
  let proxyEnabled=false;

  // ---------- Sidebar collapse ----------
  function setSidebarCollapsed(on){
    if(on) document.body.classList.add('sidebar-collapsed');
    else document.body.classList.remove('sidebar-collapsed');
    data.settings.sidebarCollapsed=!!on; save();
  }
  document.getElementById('toggleSidebar').onclick=()=> setSidebarCollapsed(!document.body.classList.contains('sidebar-collapsed'));

  // ---------- Sidebar Units ----------
  function renderUnitsList(){
    const list = $('#unitList');
    list.innerHTML='';
    data.units.forEach(u=>{
      const div = document.createElement('div'); div.className='unit';
      div.innerHTML = `<div class="dot" style="background:${u.color}"></div>
        <div class="name">${u.name}</div>
        <div class="tiny">${countBookings(u.id)} bookings</div>
        <div class="actions">
          <button data-act="sync">Sync‚Ä¶</button>
          <button data-act="edit">Edit</button>
          <button data-act="del">Delete</button>
        </div>`;
      div.querySelector('[data-act="sync"]').onclick = ()=> openSyncModal(u.id);
      div.querySelector('[data-act="edit"]').onclick = ()=> editUnit(u.id);
      div.querySelector('[data-act="del"]').onclick = ()=> delUnit(u.id);
      list.appendChild(div);
    });
  }
  function countBookings(unitId){ return data.bookings.filter(b=>b.unitId===unitId).length; }

  // Add Unit (with nightlyDefault)
  document.getElementById('addUnit').onclick = ()=>{
    const name = $('#unitName').value.trim();
    if(!name){ toast('Please enter a unit name.'); return; }
    const color = $('#unitColor').value || '#66b3ff';
    data.units.push({ id:uid(), name, color, nightlyDefault:0, icals:{airbnb:'',booking:'',vrbo:'',other:''}, autoSync:false, lastSync:null });
    save(); $('#unitName').value='';
    toast('Unit added: ' + name);
    renderUnitsList(); if ($('.tab.active').dataset.tab==='units') renderUnitsView();
  };
  function editUnit(id){
    const u = data.units.find(x=>x.id===id); if(!u) return;
    const name = prompt('Rename unit', u.name) || u.name;
    let color = prompt('Color (hex like #66b3ff)', u.color) || u.color;
    if (!/^#([0-9a-f]{3}|[0-9a-f]{6})$/i.test(color)) color = u.color;
    const rate = parseFloat(prompt('Default nightly rate (optional)', u.nightlyDefault||0));
    u.name = name; u.color = color; u.nightlyDefault = isFinite(rate)?rate:(u.nightlyDefault||0);
    save(); renderUnitsList(); if ($('.tab.active').dataset.tab==='units') renderUnitsView();
  }
  function delUnit(id){
    if (!confirm('Delete this unit? Bookings & expenses for it will also be removed.')) return;
    data.bookings = data.bookings.filter(b=>b.unitId!==id);
    data.expenses = data.expenses.filter(e=>e.unitId!==id);
    data.units = data.units.filter(u=>u.id!==id);
    save(); renderUnitsList(); route();
  }

  // ---------- Tabs Routing ----------
  $$('.tab').forEach(t=>t.onclick=()=>{ $$('.tab').forEach(x=>x.classList.remove('active')); t.classList.add('active'); route(); });
  function route(){
    const tab = $('.tab.active').dataset.tab;
    if (tab==='master') renderMaster();
    if (tab==='units') renderUnitsView();
    if (tab==='bookings') renderBookings();
    if (tab==='earnings') renderEarnings();
    if (tab==='expenses') renderExpenses();
    if (tab==='settings') renderSettings();
  }

  // ---------- Master Calendar ----------
  let masterYear = new Date().getFullYear(), masterMonth = new Date().getMonth();
  function renderMaster(){
    const view = $('#view');
    const ym = new Date(masterYear, masterMonth, 1).toLocaleString(undefined, { month:'long', year:'numeric' });
    let html = `<div class="calbar row"><div class="row">
      <button id="mPrev">‚óÄ</button><div style="min-width:160px;text-align:center">${ym}</div><button id="mNext">‚ñ∂</button>
    </div>
    <span class="spacer"></span>
    <button id="addBooking" class="primary">+ New Booking</button>
    </div>`;
    html += `<div class="calendar">`;
    ['Mon','Tue','Wed','Thu','Fri','Sat','Sun'].forEach(d=> html+=`<div class="dow">${d}</div>`);
    const weeks = monthMatrix(masterYear, masterMonth);
    weeks.forEach(week=>{
      week.forEach(day=>{
        const inMonth = day.getMonth()===masterMonth;
        const dayBookings = data.bookings.filter(b=> overlapsDay(b, day) );
        html += `<div class="cell" data-date="${day.toISOString().slice(0,10)}" style="opacity:${inMonth?1:.45}">
          <div class="add-mini" data-add="${day.toISOString().slice(0,10)}">Ôºã</div>
          <div class="date">${day.getDate()}</div>
          ${dayBookings.map(b=>renderPill(b)).join('')}
        </div>`;
      });
    });
    html += `</div>`;
    view.innerHTML = html;
    document.getElementById('mPrev').onclick = ()=>{ masterMonth--; if(masterMonth<0){masterMonth=11; masterYear--; } renderMaster(); };
    document.getElementById('mNext').onclick = ()=>{ masterMonth++; if(masterMonth>11){masterMonth=0; masterYear++; } renderMaster(); };
    document.getElementById('addBooking').onclick = ()=> openBookingModal();
    $$('.cell [data-add]').forEach(el=> el.onclick = (e)=> openBookingModal({checkIn: e.currentTarget.dataset.add}) );
    $$('.pill').forEach(p=> p.onclick=()=> openBookingModal({id:p.dataset.id}) );
  }
  function overlapsDay(b, day){
    const d = day.toISOString().slice(0,10);
    return b.checkIn <= d && d < b.checkOut; // nights-based
  }
  function renderPill(b){
    const color = unitColor(b.unitId);
    const cap = `${shortDate(b.checkIn)}‚Üí${shortDate(b.checkOut)} ¬∑ ${b.guest||''}`;
    return `<div class="pill" data-id="${b.id}" title="${unitName(b.unitId)} | ${b.guest||''} | ${b.checkIn}‚Üí${b.checkOut}" style="border-left-color:${color}">
      <span class="cap">${unitName(b.unitId)}</span> ‚Äî ${cap}
    </div>`;
  }

  // ---------- Units & Calendars ----------
  let unitsYear = new Date().getFullYear(), unitsMonth = new Date().getMonth();
  function renderUnitsView(){
    const view = $('#view');
    if (!data.units.length){
      view.innerHTML = `<div class="hint">Add some units on the left to begin.</div>`; return;
    }
    const ym = new Date(unitsYear, unitsMonth, 1).toLocaleString(undefined, { month:'long', year:'numeric' });
    let html = `
      <div class="calbar row" style="margin-bottom:12px">
        <div class="row">
          <button id="uPrev">‚óÄ</button>
          <div style="min-width:160px;text-align:center">${ym}</div>
          <button id="uNext">‚ñ∂</button>
        </div>
        <span class="spacer"></span>
        <div class="tiny">Viewing month for all unit calendars</div>
      </div>
    `;
    html += data.units.map(u=>`
      <div class="card" style="margin-bottom:12px">
        <div class="row" style="align-items:center;margin-bottom:6px">
          <div class="dot" style="background:${u.color}"></div>
          <h3 style="margin:0">${u.name}</h3>
          <div class="tiny" style="display:flex;align-items:center;gap:6px">
            <label class="tiny">Default nightly</label>
            <input data-rate="${u.id}" type="number" min="0" step="0.01" value="${u.nightlyDefault||0}" style="width:110px" />
          </div>
          <span class="spacer"></span>
          <button data-sync="${u.id}">Sync‚Ä¶</button>
          <button data-add="${u.id}" class="primary">+ Booking</button>
        </div>
        ${renderUnitCalendar(u.id, unitsYear, unitsMonth)}
      </div>`).join('');
    view.innerHTML = html;
    const prev = document.getElementById('uPrev');
    const next = document.getElementById('uNext');
    if (prev) prev.onclick = ()=>{ unitsMonth--; if (unitsMonth<0){ unitsMonth=11; unitsYear--; } renderUnitsView(); };
    if (next) next.onclick = ()=>{ unitsMonth++; if (unitsMonth>11){ unitsMonth=0; unitsYear++; } renderUnitsView(); };
    $$('button[data-add]').forEach(b=> b.onclick=()=> openBookingModal({unitId:b.dataset.add}) );
    $$('button[data-sync]').forEach(b=> b.onclick=()=> openSyncModal(b.dataset.sync) );
    $$('input[data-rate]').forEach(inp=>{
      inp.onchange=()=>{ const u=data.units.find(x=>x.id===inp.dataset.rate); if(!u) return; u.nightlyDefault=parseFloat(inp.value||'0')||0; save(); toast('Default nightly updated'); };
    });
    $$('.pill').forEach(p=> p.onclick=()=> openBookingModal({id:p.dataset.id}) );
  }
  function renderUnitCalendar(unitId, year, month){
    const weeks = monthMatrix(year, month);
    let html = `<div class="calendar">`;
    ['Mon','Tue','Wed','Thu','Fri','Sat','Sun'].forEach(d=> html+=`<div class="dow">${d}</div>`);
    weeks.forEach(week=>{
      week.forEach(day=>{
        const inMonth = day.getMonth()===month;
        const list = data.bookings.filter(b=> b.unitId===unitId && overlapsDay(b, day) );
        html += `<div class="cell" style="opacity:${inMonth?1:.45}">
          <div class="date">${day.getDate()}</div>
          ${list.map(b=>renderPill(b)).join('')}
        </div>`;
      });
    });
    html += `</div>`;
    return html;
  }
  // ---------- Bookings List ----------
  function renderBookings(){
    const view = $('#view');
    const unitsOpts = ['<option value="">All units</option>'].concat(data.units.map(u=>`<option value="${u.id}">${u.name}</option>`)).join('');
    const sources = ['All','Airbnb','Booking.com','Vrbo','Direct','Other','Airbnb iCal','Booking.com iCal','Vrbo iCal','Other iCal','iCal file'].map(s=>`<option>${s}</option>`).join('');
    const statuses = ['All','booked','blocked','maintenance','hold','cancelled'].map(s=>`<option value="${s}">${s[0].toUpperCase()+s.slice(1)}</option>`).join('');
    let html = `<div class="row" style="margin-bottom:8px">
      <select id="fUnit">${unitsOpts}</select>
      <select id="fSource">${sources}</select>
      <select id="fStatus">${statuses}</select>
      <input id="fFrom" type="date" /><input id="fTo" type="date" />
      <button id="fApply">Apply</button>
      <span class="spacer"></span>
      <label class="tiny">Import .ics <input id="icsFileBookings" type="file" accept=".ics,text/calendar" /></label>
      <button id="addBooking" class="primary">+ New Booking</button>
    </div>`;
    html += `<table><thead><tr><th>Unit</th><th>Guest</th><th>In</th><th>Out</th><th class="right">Nights</th><th class="right">Total</th><th>Source</th><th>Status</th><th></th></tr></thead><tbody id="bkRows"></tbody></table>`;
    view.innerHTML = html;
    document.getElementById('addBooking').onclick = ()=> openBookingModal();
    document.getElementById('fApply').onclick = renderBookingRows;
    document.getElementById('icsFileBookings').addEventListener('change', onIcsUpload);
    renderBookingRows();

    function filterList(){
      const fu = document.getElementById('fUnit').value, fs=document.getElementById('fSource').value, fst=document.getElementById('fStatus').value, ff=document.getElementById('fFrom').value, ft=document.getElementById('fTo').value;
      let list = data.bookings.slice();
      if (fu) list = list.filter(b=> b.unitId===fu);
      if (fs && fs!=='All') list = list.filter(b=> b.source===fs);
      if (fst && fst!=='All') list = list.filter(b=> b.status===fst);
      if (ff) list = list.filter(b=> b.checkOut>ff);
      if (ft) list = list.filter(b=> b.checkIn<ft);
      list.sort((a,b)=> a.checkIn.localeCompare(b.checkIn));
      return list;
    }
    function renderBookingRows(){
      const rows = document.getElementById('bkRows'); rows.innerHTML='';
      const list = filterList();
      rows.innerHTML = list.map(b=> `<tr>
        <td>${unitName(b.unitId)}</td>
        <td>${b.guest||''}</td>
        <td>${b.checkIn}</td>
        <td>${b.checkOut}</td>
        <td class="right">${b.nights||''}</td>
        <td class="right">${fmtMoney(b.total||0)}</td>
        <td>${b.source||''}</td>
        <td><span class="badge">${b.status||''}</span></td>
        <td><button data-id="${b.id}">Edit</button></td>
      </tr>`).join('');
      $$('#bkRows [data-id]').forEach(btn=> btn.onclick=()=> openBookingModal({id:btn.dataset.id}) );
    }

    async function onIcsUpload(e){
      const f = e.target.files[0]; if(!f) return;
      const text = await f.text();
      const events = parseICS(text);
      let added = 0, flagged=0;
      let unitId = document.getElementById('fUnit').value || (data.units[0]?.id || null);
      if (!unitId){ alert('Create a unit first.'); return; }
      for (const ev of events){
        const nights = daysBetween(ev.start, ev.end); if (!nights) continue;

        const nightlyRate = getUnitDefaultRate(unitId);
        const cleaning = 0, fees = 0;
        const total = nights * nightlyRate + cleaning + fees;

        const row = { id:uid(), unitId, guest: ev.summary || '', checkIn: ev.start, checkOut: ev.end, nights,
          nightlyRate, cleaning, fees, total, source: 'iCal file', status: 'booked', notes: 'Imported from .ics', importUid: ev.uid||null };

        if(findDupBooking(row)) continue;
        const conflicts=findOverlaps(unitId, ev.start, ev.end, null);
        if(conflicts.length){ row.status='hold'; flagged++; logConflict(row, conflicts, 'overlap-import'); }
        data.bookings.push(row); added++;
      }
      save(); toast(`Imported ${added} events${flagged?`, ${flagged} flagged`:''}.`); e.target.value=''; renderBookingRows(); route();
    }
  }

  // ---------- Earnings ----------
  function renderEarnings(){
    const view = $('#view');
    const from = toISO(new Date(new Date().setMonth(new Date().getMonth()-1)));
    const to = toISO(new Date(new Date().setDate(new Date().getDate()+30)));
    view.innerHTML = `<div class="row" style="margin-bottom:8px">
      <div class="flex"><span>From</span><input id="eFrom" type="date" value="${from}"></div>
      <div class="flex"><span>To</span><input id="eTo" type="date" value="${to}"></div>
      <button id="eApply">Update</button>
      <span class="spacer"></span>
      <div class="flex"><span>Currency</span><select id="curSel">
        ${['SEK','USD','EUR','GBP','ZAR'].map(c=>`<option ${data.settings.currency===c?'selected':''}>${c}</option>`).join('')}
      </select></div>
    </div>
    <div class="grid">
      <div class="card kpi" style="grid-column:span 3"><span class="tiny">Gross revenue</span><span class="v" id="kGross">‚Äî</span></div>
      <div class="card kpi" style="grid-column:span 3"><span class="tiny">Nights booked</span><span class="v" id="kNights">‚Äî</span></div>
      <div class="card kpi" style="grid-column:span 2"><span class="tiny">ADR</span><span class="v" id="kADR">‚Äî</span></div>
      <div class="card kpi" style="grid-column:span 2"><span class="tiny">Occupancy</span><span class="v" id="kOcc">‚Äî</span></div>
      <div class="card kpi" style="grid-column:span 2"><span class="tiny">RevPAR</span><span class="v" id="kRevPAR">‚Äî</span></div>
    </div>`;
    document.getElementById('eApply').onclick = calc;
    document.getElementById('curSel').onchange = ()=>{ data.settings.currency = document.getElementById('curSel').value; save(); calc(); };
    calc();
    function overlapNights(b, from, to){
      const s = new Date(Math.max(new Date(b.checkIn), new Date(from)));
      const e = new Date(Math.min(new Date(b.checkOut), new Date(to)));
      return Math.max(0, Math.round((e-s)/(1000*60*60*24)));
    }
    function proRatedTotal(b, from, to){
      const nights = overlapNights(b, from, to);
      if (!nights) return 0;
      const base = (b.nightlyRate||0) * nights;
      const ratio = nights / (b.nights||1);
      return base + (b.cleaning||0)*ratio + (b.fees||0)*ratio;
    }
    function calc(){
      const from = document.getElementById('eFrom').value || '1900-01-01';
      const to   = document.getElementById('eTo').value || '2999-12-31';
      const days = daysBetween(from,to);
      const availNights = days * Math.max(1, data.units.length);
      const inRange = data.bookings.filter(b=> b.status==='booked' && b.checkOut>from && b.checkIn<to);
      const nights = inRange.reduce((s,b)=> s + overlapNights(b, from, to), 0);
      const revenue = inRange.reduce((s,b)=> s + proRatedTotal(b, from, to), 0);
      const adr = nights ? revenue / nights : 0;
      const occ = availNights ? nights / availNights : 0;
      const revpar = adr * occ;
      document.getElementById('kGross').textContent = fmtMoney(revenue);
      document.getElementById('kNights').textContent = nights.toString();
      document.getElementById('kADR').textContent = fmtMoney(adr);
      document.getElementById('kOcc').textContent = (occ*100).toFixed(1)+'%';
      document.getElementById('kRevPAR').textContent = fmtMoney(revpar);
    }
  }

  // ---------- Expenses ----------
  function renderExpenses(){
    const view = $('#view');
    const unitSel = ['<option value="">General</option>'].concat(data.units.map(u=>`<option value="${u.id}">${u.name}</option>`)).join('');
    view.innerHTML = `<div class="row" style="margin-bottom:8px">
      <select id="exUnit">${unitSel}</select>
      <input id="exDate" type="date" value="${toISO(new Date())}" />
      <input id="exDesc" placeholder="Description (optional)" />
      <input id="exAmt" type="number" step="0.01" placeholder="Amount *" />
      <select id="exCat"><option>Supplies</option><option>Cleaning</option><option>Maintenance</option><option>Utilities</option><option>Other</option></select>
      <button id="exAdd" class="primary">+ Add</button>
    </div>
    <table><thead><tr><th>Date</th><th>Unit</th><th>Description</th><th>Category</th><th class="right">Amount</th><th></th></tr></thead><tbody id="exRows"></tbody></table>`;
    document.getElementById('exAdd').onclick = ()=>{
      const unitId=document.getElementById('exUnit').value||null;
      const date=document.getElementById('exDate').value||toISO(new Date());
      const desc=document.getElementById('exDesc').value.trim();
      const amt=parseFloat(document.getElementById('exAmt').value||'0');
      const cat=document.getElementById('exCat').value||'Other';
      if(!isFinite(amt)||amt===0){ alert('Please enter an amount.'); return; }
      data.expenses.push({ id:uid(), unitId, date, desc, cat, amt }); save(); renderExpenses();
    };
    const tbody = document.getElementById('exRows');
    tbody.innerHTML = data.expenses.slice().sort((a,b)=> b.date.localeCompare(a.date)).map(x=> `<tr>
      <td>${x.date||''}</td><td>${x.unitId?unitName(x.unitId):'General'}</td><td>${x.desc||''}</td><td>${x.cat||''}</td>
      <td class="right">${fmtMoney(x.amt||0)}</td>
      <td><button data-del="${x.id}">Delete</button></td>
    </tr>`).join('');
    $$('button[data-del]').forEach(btn=> btn.onclick=()=>{ data.expenses = data.expenses.filter(e=> e.id!==btn.dataset.del); save(); renderExpenses(); });
  }
  // ---------- Settings ----------
  function renderSettings(){
    document.getElementById('view').innerHTML = `<div class="row">
      <div class="col"><label>Currency</label>
        <select id="setCur">${['SEK','USD','EUR','GBP','NOK','DKK','ZAR'].map(c=>`<option ${data.settings.currency===c?'selected':''}>${c}</option>`).join('')}</select>
      </div>
      <div class="col">
        <label>Backup/Restore</label>
        <div class="row">
          <button id="backupGit" class="primary">Backup to GitHub</button>
          <button id="restoreGit">Restore from GitHub</button>
        </div>
        <label class="tiny" style="margin-top:8px">
          <input id="autoRestoreChk" type="checkbox" ${data.settings.autoRestoreFromGit?'checked':''} />
          Auto‚Äërestore from GitHub on app open
        </label>
        <div class="tiny">Set env vars GH_TOKEN, GH_OWNER, GH_REPO, GH_PATH, GH_BRANCH on Netlify.</div>
      </div>
    </div>`;
    document.getElementById('setCur').onchange = ()=>{
      data.settings.currency = document.getElementById('setCur').value; save(); toast('Saved.');
    };

    document.getElementById('backupGit').onclick = async ()=>{
      data.meta = data.meta || {}; data.meta.updatedAt = new Date().toISOString();
      const res = await fetch('/.netlify/functions/push-data',{ method:'POST', body: JSON.stringify(data) });
      if (res.ok){ markClean(); toast('Backup saved to GitHub ‚úÖ'); }
      else { toast('Backup failed ‚ùå'); }
    };

    document.getElementById('restoreGit').onclick = async ()=>{
      const res = await fetch('/.netlify/functions/pull-data',{ cache:'no-store' });
      if(!res.ok){ toast('Restore failed ‚ùå'); return; }
      const json = await res.json();
      if(!confirm('Replace your local data with the GitHub backup?')) return;
      localStorage.setItem(KEY, JSON.stringify(json));
      markClean();
      location.reload();
    };

    document.getElementById('autoRestoreChk').onchange = (e)=>{
      data.settings.autoRestoreFromGit = !!e.target.checked;
      save(); toast('Auto‚Äërestore setting saved.');
    };
  }

  // ---------- Booking Modal ----------
  let editingBookingId = null;
  function openBookingModal(prefill={}){
    const sel = document.getElementById('bkUnit'); sel.innerHTML = data.units.map(u=>`<option value="${u.id}">${u.name}</option>`).join('');
    if (!data.units.length){ alert('Add units first.'); return; }
    const b = prefill.id ? data.bookings.find(x=>x.id===prefill.id) : null;
    editingBookingId = b ? b.id : null;
    const useUnit = b? b.unitId : (prefill.unitId || data.units[0].id);
    document.getElementById('bkUnit').value = useUnit;
    document.getElementById('bkGuest').value = b ? (b.guest||'') : '';
    document.getElementById('bkIn').value = b ? b.checkIn : (prefill.checkIn || toISO(new Date()));
    document.getElementById('bkOut').value = b ? b.checkOut : toISO(new Date(new Date().setDate(new Date().getDate()+1)));
    document.getElementById('bkNights').value = b ? b.nights : 1;
    document.getElementById('bkNightly').value = b ? (b.nightlyRate||0) : getUnitDefaultRate(useUnit);
    document.getElementById('bkCleaning').value = b ? (b.cleaning||0) : 0;
    document.getElementById('bkFees').value = b ? (b.fees||0) : 0;
    document.getElementById('bkSource').value = b ? b.source : 'Airbnb';
    document.getElementById('bkStatus').value = b ? b.status : 'booked';
    document.getElementById('bkNotes').value = b ? (b.notes||'') : '';
    recalcTotal();
    document.getElementById('deleteBooking').style.display = b ? 'inline-block' : 'none';
    document.getElementById('bookingModal').style.display = 'flex';
  }
  function closeBooking(){ document.getElementById('bookingModal').style.display = 'none'; }
  document.getElementById('closeBooking').onclick = closeBooking;
  document.getElementById('deleteBooking').onclick = ()=>{
    if (!editingBookingId) return;
    if (!confirm('Delete this booking?')) return;
    data.bookings = data.bookings.filter(x=> x.id!==editingBookingId);
    save(); closeBooking(); route();
  };
  function recalcTotal(){
    const n = parseInt(document.getElementById('bkNights').value||'0',10);
    const nightly = parseFloat(document.getElementById('bkNightly').value||'0');
    const clean = parseFloat(document.getElementById('bkCleaning').value||'0');
    const fees = parseFloat(document.getElementById('bkFees').value||'0');
    const total = n*nightly + clean + fees;
    const kpi = document.getElementById('bkTotal');
    if (kpi) kpi.textContent = fmtMoney(total);
  }
  ['#bkNights','#bkNightly','#bkCleaning','#bkFees','#bkIn','#bkOut'].forEach(sel=>{
    const el = document.querySelector(sel);
    if(!el) return;
    el.oninput = ()=>{
      const inEl = document.getElementById('bkIn');
      const outEl = document.getElementById('bkOut');
      if (inEl && outEl && inEl.value && outEl.value){
        const n = Math.max(0, Math.round((new Date(outEl.value)-new Date(inEl.value))/(1000*60*60*24)));
        const nEl = document.getElementById('bkNights'); if (nEl) nEl.value = n;
      }
      recalcTotal();
    };
  });
  document.getElementById('saveBooking').onclick = ()=>{
    const unitId = document.getElementById('bkUnit').value;
    const guest = (document.getElementById('bkGuest').value||'').trim();
    const checkIn = document.getElementById('bkIn').value;
    const checkOut = document.getElementById('bkOut').value;
    const nights = parseInt(document.getElementById('bkNights').value||'0',10);
    let nightlyRate = parseFloat(document.getElementById('bkNightly').value||'0');
    const cleaning = parseFloat(document.getElementById('bkCleaning').value||'0');
    const fees = parseFloat(document.getElementById('bkFees').value||'0');
    const source = document.getElementById('bkSource').value;
    const status = document.getElementById('bkStatus').value;
    const notes = (document.getElementById('bkNotes').value||'').trim();
    if (!unitId || !checkIn || !checkOut || nights<=0){ alert('Please fill unit and valid dates.'); return; }
    if (!isFinite(nightlyRate) || nightlyRate===0) nightlyRate = getUnitDefaultRate(unitId);
    const row = {
      id: editingBookingId || uid(), unitId, guest, checkIn, checkOut, nights,
      nightlyRate, cleaning, fees, total: nights*nightlyRate + cleaning + fees, source, status, notes
    };
    if(!editingBookingId){
      const dup = findDupBooking(row);
      if (dup){ toast('Duplicate booking ignored'); return; }
    }
    const conflicts = findOverlaps(unitId, checkIn, checkOut, editingBookingId||null);
    if (conflicts.length){
      row.status = row.status || 'hold';
      logConflict(row, conflicts, editingBookingId?'overlap-edit':'overlap-new');
    }
    if (editingBookingId){ Object.assign(data.bookings.find(x=>x.id===editingBookingId), row); }
    else { data.bookings.push(row); }
    save(); closeBooking(); route();
  };
  // ---------- Sync Modal & Logic ----------
  let syncUnitId=null;
  function openSyncModal(unitId){
    syncUnitId = unitId;
    const u = data.units.find(x=>x.id===unitId); if(!u) return;
    u.icals = u.icals || {airbnb:'',booking:'',vrbo:'',other:''};
    document.getElementById('icalAirbnb').value = u.icals.airbnb||'';
    document.getElementById('icalBooking').value = u.icals.booking||'';
    document.getElementById('icalVrbo').value   = u.icals.vrbo||'';
    document.getElementById('icalOther').value  = u.icals.other||'';
    document.getElementById('autoSync').checked = !!u.autoSync;
    document.getElementById('lastSyncRow').textContent = u.lastSync ? ('Last sync: '+u.lastSync) : 'Never synced';
    document.getElementById('funcHint').textContent = proxyEnabled ? 'Proxy ON: Import via Proxy will fetch URLs.' : 'Proxy OFF: Use .ics upload or enable function.';
    document.getElementById('syncModal').style.display='flex';
  }
  document.getElementById('syncSave').onclick = ()=>{
    const u = data.units.find(x=>x.id===syncUnitId); if(!u) return;
    u.icals = {
      airbnb: document.getElementById('icalAirbnb').value.trim(),
      booking: document.getElementById('icalBooking').value.trim(),
      vrbo: document.getElementById('icalVrbo').value.trim(),
      other: document.getElementById('icalOther').value.trim()
    };
    u.autoSync = document.getElementById('autoSync').checked;
    save(); toast('Sync settings saved' + (proxyEnabled?'':' (proxy off)'));
  };
  document.getElementById('syncClose').onclick = ()=> document.getElementById('syncModal').style.display='none';

  // Upload .ics for this unit
  document.getElementById('icsFile').addEventListener('change', async (e)=>{
    const f = e.target.files[0]; if(!f) return;
    const text = await f.text();
    const events = parseICS(text);
    const u = data.units.find(x=>x.id===syncUnitId) || data.units[0];
    if (!u){ alert('Create a unit first.'); return; }
    let added=0, flagged=0;
    for (const ev of events){
      const nights = daysBetween(ev.start, ev.end); if (!nights) continue;
      const nightlyRate = getUnitDefaultRate(u.id);
      const rec = { id: uid(), unitId: u.id, guest: ev.summary||'', checkIn: ev.start, checkOut: ev.end,
        nights, nightlyRate, cleaning: 0, fees: 0, total: nights*nightlyRate, source: 'iCal file', status: 'booked', notes: 'Imported from .ics', importUid: ev.uid||null };
      if (findDupBooking(rec)) continue;
      const conf = findOverlaps(u.id, ev.start, ev.end, null);
      if (conf.length){ rec.status='hold'; flagged++; logConflict(rec, conf, 'overlap-import'); }
      data.bookings.push(rec); added++;
    }
    save(); toast(`Imported ${added} events${flagged?`, ${flagged} flagged`:''}.`); e.target.value=''; route();
  });

  // Import via Netlify Function (proxy)
  document.getElementById('syncProxy').onclick = async ()=>{
    if (!proxyEnabled){ alert('Proxy is off. Deploy the fetch-ical function.'); return; }
    const u = data.units.find(x=>x.id===syncUnitId); if(!u) return;
    const urls = Object.values(u.icals||{}).filter(Boolean);
    if (!urls.length){ alert('Add at least one iCal URL.'); return; }
    let totalAdded=0, flagged=0;
    for (const url of urls){
      try{
        const res = await fetch('/.netlify/functions/fetch-ical?url='+encodeURIComponent(url), {cache:'no-store'});
        if (!res.ok) continue;
        const text = await res.text();
        const events = parseICS(text);
        for (const ev of events){
          const nights = daysBetween(ev.start, ev.end); if (!nights) continue;
          const nightlyRate = getUnitDefaultRate(u.id);
          const rec = { id: uid(), unitId: u.id, guest: ev.summary||'', checkIn: ev.start, checkOut: ev.end,
            nights, nightlyRate, cleaning: 0, fees: 0, total: nights*nightlyRate, source:'Other iCal', status:'booked', notes:'Imported via proxy', importUid: ev.uid||null };
          if (findDupBooking(rec)) continue;
          const conf = findOverlaps(u.id, ev.start, ev.end, null);
          if (conf.length){ rec.status='hold'; flagged++; logConflict(rec, conf, 'overlap-import'); }
          data.bookings.push(rec); totalAdded++;
        }
      }catch(e){}
    }
    u.lastSync = new Date().toISOString();
    save(); toast(`Imported ${totalAdded} events${flagged?`, ${flagged} flagged`:''}.`); route();
  };

  // ---------- ICS parser ----------
  function parseICS(text){
    const lines = text.split(/\r?\n/);
    const events=[]; let cur=null;
    const dtfix = v => {
      if (!v) return null;
      if (/^\d{8}$/.test(v)){ const y=v.slice(0,4), m=v.slice(4,6), d=v.slice(6,8); return `${y}-${m}-${d}`; }
      if (/^\d{8}T\d{6}Z?$/.test(v)){ const y=v.slice(0,4), m=v.slice(4,6), d=v.slice(6,8); return `${y}-${m}-${d}`; }
      const d = new Date(v); if(!isNaN(d)) return toISO(d);
      return v;
    };
    for (let raw of lines){
      const line = raw.trim();
      if (line==='BEGIN:VEVENT'){ cur={}; continue; }
      if (line==='END:VEVENT'){
        if(cur.start&&cur.end){ events.push({start:cur.start,end:cur.end,summary:cur.summary||'',uid:cur.uid||null}); }
        cur=null; continue;
      }
      if (!cur) continue;
      if (line.startsWith('DTSTART')){ const v=line.split(':').pop(); cur.start=dtfix(v); }
      else if (line.startsWith('DTEND')){ const v=line.split(':').pop(); cur.end=dtfix(v); }
      else if (line.startsWith('SUMMARY')){ cur.summary=line.split(':').slice(1).join(':'); }
      else if (line.startsWith('UID')){ cur.uid=line.split(':').slice(1).join(':'); }
    }
    return events;
  }

  // ---------- Export/Import JSON ----------
  document.getElementById('exportBtn').onclick = ()=>{
    const blob = new Blob([JSON.stringify(data,null,2)], {type:'application/json'});
    const a = document.createElement('a'); a.href = URL.createObjectURL(blob);
    a.download = 'bnb_data_backup.json'; a.click();
  };
  document.getElementById('importBtn').onclick = ()=> document.getElementById('importFile').click();
  document.getElementById('importFile').onchange = (e)=>{
    const f = e.target.files[0]; if(!f) return;
    const reader = new FileReader();
    reader.onload = ()=>{
      try{
        const obj = JSON.parse(reader.result);
        if (!obj.units || !obj.bookings) throw new Error('Invalid file');
        data.units = obj.units; data.bookings = obj.bookings; data.expenses = obj.expenses||[]; data.settings = Object.assign({currency:'SEK',sidebarCollapsed:false,autoRestoreFromGit:true}, obj.settings||{});
        data.conflicts = obj.conflicts||[];
        data.meta = obj.meta||{updatedAt:new Date().toISOString()};
        save(); renderUnitsList(); route(); alert('Import successful.');
      }catch(err){ alert('Import failed: '+err.message); }
    };
    reader.readAsText(f);
  };

  // ---------- GitHub helpers ----------
  async function fetchGitBackup(){
    try{
      const res = await fetch('/.netlify/functions/pull-data', {cache:'no-store'});
      if(!res.ok) return null;
      return await res.json();
    }catch(e){ return null; }
  }
  function newerThan(aIso, bIso){
    if (!aIso) return false;
    if (!bIso) return true;
    return new Date(aIso).getTime() > new Date(bIso).getTime();
  }
  function hasMeaningfulLocalData(){
    return (data.units && data.units.length) || (data.bookings && data.bookings.length) || (data.expenses && data.expenses.length);
  }

  // ---------- Header actions ----------
  document.getElementById('viewConflicts').onclick = ()=>{
    const cs = (data.conflicts||[]);
    if(!cs.length){ alert('No conflicts üéâ'); return; }
    alert('Conflicts:\n'+JSON.stringify(cs, null, 2));
  };
  document.getElementById('syncAll').onclick = async ()=>{
    if (!proxyEnabled){ alert('Proxy is off. Deploy the fetch-ical function.'); return; }
    let total=0, flagged=0;
    for (const u of data.units){
      const urls = Object.values(u.icals||{}).filter(Boolean);
      for (const url of urls){
        try{
          const res = await fetch('/.netlify/functions/fetch-ical?url='+encodeURIComponent(url), {cache:'no-store'});
          if (!res.ok) continue;
          const text = await res.text();
          const events = parseICS(text);
          for (const ev of events){
            const nights = daysBetween(ev.start, ev.end); if (!nights) continue;
            const nightlyRate = getUnitDefaultRate(u.id);
            const rec = {
              id: uid(), unitId: u.id, guest: ev.summary||'',
              checkIn: ev.start, checkOut: ev.end, nights,
              nightlyRate, cleaning: 0, fees: 0,
              total: nights*nightlyRate,
              source:'Other iCal', status:'booked', notes:'Imported via proxy', importUid: ev.uid||null
            };
            if (findDupBooking(rec)) continue;
            const conf = findOverlaps(u.id, ev.start, ev.end, null);
            if (conf.length){ rec.status='hold'; flagged++; logConflict(rec, conf, 'overlap-import'); }
            data.bookings.push(rec); total++;
          }
        }catch(e){}
      }
      u.lastSync = new Date().toISOString();
    }
    save(); toast(`Sync all: ${total} added${flagged?`, ${flagged} flagged`:''}.`); route();
  };

 
 // Wire "Save changes" to: save locally + push to GitHub (same as Settings ‚Üí Backup)
(function(){
  const btn = document.getElementById('saveChangesBtn');
  if (!btn) return;

  btn.onclick = async ()=>{
    // Save local first & bump updatedAt (same as backup button)
    data.meta = data.meta || {};
    data.meta.updatedAt = new Date().toISOString();
    localStorage.setItem(KEY, JSON.stringify(data));
    updateConflictBadge();

    // Push to GitHub (same endpoint as Settings ‚Üí Backup)
    try{
      const res = await fetch('/.netlify/functions/push-data', {
        method: 'POST',
        body: JSON.stringify(data)
      });
      if (!res.ok) throw new Error('push failed');
      markClean();
      toast('Saved locally + GitHub ‚úÖ');
    }catch(e){
      // Still saved locally even if GitHub fails
      toast('Saved locally. GitHub backup failed ‚ùå');
    }
  };
})();

// --- Auto-backup helpers ---
function buildBackupPayload(){
  // bump updatedAt and persist to localStorage first
  data.meta = data.meta || {};
  data.meta.updatedAt = new Date().toISOString();
  localStorage.setItem(KEY, JSON.stringify(data));
  updateConflictBadge();
  return JSON.stringify(data);
}

function sendBackupBeacon(payload){
  try{
    if (navigator.sendBeacon){
      const blob = new Blob([payload], { type: 'application/json' });
      return navigator.sendBeacon('/.netlify/functions/push-data', blob);
    }
  }catch(_){}
  return false;
}

async function sendBackupKeepalive(payload){
  try{
    // keepalive lets the request finish after unload (supported in modern browsers)
    await fetch('/.netlify/functions/push-data', {
      method: 'POST',
      body: payload,
      headers: { 'Content-Type': 'application/json' },
      keepalive: true,
      cache: 'no-store'
    });
    return true;
  }catch(_){ return false; }
}
  

  // ---------- Init (ALWAYS restore from GitHub on open if available) ----------
(async function init(){
  // Detect proxy (Netlify function)
  proxyEnabled = await checkProxy();
  const ml = document.getElementById('modeLabel');
  if (ml) ml.textContent = proxyEnabled ? '(proxy ON)' : '(proxy OFF)';

  // Restore sidebar state
  setSidebarCollapsed(!!data.settings.sidebarCollapsed);

  // Force "Restore from GitHub" on startup (no timestamp checks).
  try{
    const res = await fetch('/.netlify/functions/pull-data', { cache:'no-store' });
    if (res.ok){
      const remote = await res.json();
      if (remote && remote.units && remote.bookings){
        localStorage.setItem(KEY, JSON.stringify(remote)); // identical to clicking the Settings button
        Object.assign(data, remote);
        markClean();
        toast('Restored from GitHub on startup ‚úÖ');
      }
    }
  }catch(e){
    // silently ignore if offline / function not available
  }

  renderUnitsList(); route(); updateConflictBadge();
})();


 // --- Auto-backup on close / background if there are unsaved changes ---
async function autoBackupIfDirty(){
  if (!dirty) return;                 // only if there are unsaved changes
  const payload = buildBackupPayload();

  // 1) Try beacon (most reliable on unload)
  const okBeacon = sendBackupBeacon(payload);

  // 2) If beacon not available/failed, try keepalive fetch
  if (!okBeacon) await sendBackupKeepalive(payload);

  // we consider it "clean" after we attempted the upload
  markClean();
}

// Fire on tab close/navigation
window.addEventListener('beforeunload', (e)=>{
  if (dirty){
    // Kick off backup; don't block unload
    autoBackupIfDirty();

    // If you still want the warning dialog, keep these two lines:
    // e.preventDefault();
    // e.returnValue = '';
  }
});

// Fire when the page is backgrounded (helps iOS Safari)
document.addEventListener('visibilitychange', ()=>{
  if (document.visibilityState === 'hidden') autoBackupIfDirty();
});

// Fire on pagehide (Safari)
window.addEventListener('pagehide', ()=> autoBackupIfDirty());

})(); // end IIFE
</script>
</body>
</html>

